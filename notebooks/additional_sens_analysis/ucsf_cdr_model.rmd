```{r setup, message=FALSE}
# Install required packages if not already installed
required_packages <- c('lme4', 'readr', 'dplyr','ggplot2','emmeans','lmerTest','tidyverse','pbkrtest','car')
new_packages <- required_packages[!(required_packages %in% installed.packages()[,'Package'])]
if(length(new_packages)) install.packages(new_packages)
```

```{r load-packages}
library(lme4)
library(readr)
library(dplyr)
library(ggplot2)
library(emmeans)
library(lmerTest)
library(tidyverse)
library(pbkrtest)
library(car)
```

```{r load-data}
# Read the data
dat <- read_csv('/Users/mlin2/Desktop/RabLab/eoad_sustain_ml/notebooks/additional_sens_analysis/ucsf_cdrsb_long.csv')
dat$baseline_subtype <- as.factor(dat$baseline_subtype)
dat$baseline_sex <- as.factor(dat$baseline_sex)
dat$PIDN <- as.factor(dat$PIDN)
```

```{r lme-model}
# Fit the longitudinal mixed effects model
# Formula: CDRSUM ~ diff_yr * baseline_subtype + baseline_year + baseline_Educ + baseline_sex + baseline_Centiloid + (1 + diff_yr | PIDN)
model <- lmer(CDRSUM ~ diff_yr * baseline_subtype + baseline_age + baseline_Educ + baseline_sex + baseline_Centiloid + (1 + diff_yr | PIDN), data = dat)

# Model summary
summary(model)
```

```{r emmeans-slopes, message=FALSE}
library(emmeans)
# Get estimated marginal trends (slopes) for diff_yr by baseline_subtype
emtr <- emtrends(model, ~ baseline_subtype, var = "diff_yr")
summary(emtr)
```
 
```{r emmeans-contrast}
# Pairwise comparisons of slopes between subtypes
contrast(emtr, method = "pairwise")
```
 

```{r anova-interaction}
# ANOVA for interaction term
table_anova <- Anova(model)
table_anova
```


```{r ggplot, fig.height=3, fig.width=6}
# Calculate estimated marginal means (predicted values) for each subtype across years
newdata <- expand.grid(
  diff_yr = seq(min(dat$diff_yr, na.rm = TRUE), max(dat$diff_yr, na.rm = TRUE), length.out = 100),
  baseline_subtype = unique(dat$baseline_subtype),
  baseline_age = mean(dat$baseline_age, na.rm = TRUE),
  baseline_Educ = mean(dat$baseline_Educ, na.rm = TRUE),
  baseline_sex = names(sort(table(dat$baseline_sex), decreasing = TRUE))[1],
  baseline_Centiloid = mean(dat$baseline_Centiloid, na.rm = TRUE),
  PIDN = NA
)

# Get predicted values and confidence intervals
pred <- predict(model, newdata = newdata, re.form = NA, se.fit = TRUE)
newdata$fit <- pred$fit
newdata$lwr <- pred$fit - 1.96 * pred$se.fit
newdata$upr <- pred$fit + 1.96 * pred$se.fit

# Get simple slopes for annotation
emtr <- emtrends(model, ~ baseline_subtype, var = "diff_yr")
slope_df <- as.data.frame(summary(emtr))

# Get interaction p-value
anova_tab <- Anova(model)
interaction_row <- grep('diff_yr:baseline_subtype', rownames(anova_tab), value = TRUE)
if(length(interaction_row) > 0) {
  inter_p <- anova_tab[interaction_row, "Pr(>Chisq)"]
  if (!is.na(inter_p) && inter_p < 0.001) {
    inter_p_annot <- '***'
  } else {
    inter_p_annot <- formatC(inter_p, digits=3, format="f")
  }
} else {
  inter_p_annot <- NA
}

# Color scheme
subtype_colors <- c("#1f449c", "#32ABA6", "#f05039")
names(subtype_colors) <- sort(unique(dat$baseline_subtype))

# Plot
p <- ggplot() +
  # Spaghetti plot: individual trajectories colored by subtype
  geom_line(data = dat, aes(x = diff_yr, y = CDRSUM, group = PIDN, color = baseline_subtype), alpha = 0.5, size = 0.4) +
  # Estimated marginal means and CI
  geom_ribbon(data = newdata, aes(x = diff_yr, ymin = lwr, ymax = upr, fill = baseline_subtype), alpha = 0.2) +
  geom_line(data = newdata, aes(x = diff_yr, y = fit, color = baseline_subtype), size = 1.2) +
  scale_color_manual(values = subtype_colors) +
  scale_fill_manual(values = subtype_colors) +
  labs(
    x = "Years from Baseline",
    y = "CDR Sum of Boxes",
    title = "CDRSUM by Year and Subtype",
    color = "Subtype",
    fill = "Subtype"
  ) +
  theme(
    axis.text.x = element_text(size=12),
    axis.text.y = element_text(size=12),
    panel.background = element_blank(),
    plot.background = element_rect(fill = "white", color = NA),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", size = 1),
    axis.ticks = element_line(color = "black", size = 1)
  )

# Annotate simple slopes for each subtype as S1, S2, S3
for(i in 1:nrow(slope_df)) {
  st <- as.character(slope_df$baseline_subtype[i])
  slope_val <- formatC(slope_df$diff_yr.trend[i], digits=2, format="f")
  p <- p + annotate(
    "text",
    x = min(newdata$diff_yr),
    y = max(newdata$fit) - (i-1)*0.5,
    label = paste0("S", i, " slope: ", slope_val),
    color = subtype_colors[st],
    hjust = 0,
    size = 4
  )
}
# Annotate interaction p-value
if(!is.na(inter_p_annot)) {
  p <- p + annotate(
    "text",
    x = min(newdata$diff_yr),
    y = min(newdata$fit),
    label = paste0("Interaction p: ", inter_p_annot),
    color = "black",
    hjust = 0,
    size = 4,
    fontface = "bold"
  )
}

print(p)
```
