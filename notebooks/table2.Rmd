---
title: "table2"
author: "Marlene Lin"
date: "4/8/2025"
output: html_document
---

```{r}
library(dplyr)
library(stringr)
library(readr)
library(jsonlite)
setwd("/Users/linlin/Desktop/brain stuff/data/")
subject_counts <- jsonlite::read_json("subject_counts_long.json", simplifyVector = TRUE)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}

# Your variable list
var_list <- c('UDSBENTC','TRAILA','DIGFORCT','MINTTOTS','Semantic_fluency','MOCATOTS','CDRSB','ANIMALS','MOCATOTS','TRAILB','DIGBACCT','Phonemic_fluency','AVDEL30MIN','CRAFTDRE','UDSBENTD' )

# Initialize summary table
summary_table <- data.frame(
  Domain = character(0),
  Subject_Count = character(0),
  Variable = character(),
  Total_Observations = integer(),
  S1_Slope = numeric(),
  S2_Slope = numeric(),
  S3_Slope = numeric(),
  Interaction_P = character(),
  S1_vs_S2 = numeric(),
  S1_vs_S3 = numeric(),
  S2_vs_S3 = numeric(),
  stringsAsFactors = FALSE
)

# -------- Helper Functions --------

# Extract estimate from model summary text
get_estimate <- function(term, coef_lines) {
  line <- grep(paste0("^\\s*", term, "\\b"), coef_lines, value = TRUE)
  if (length(line) >= 1) {
    est <- str_split_fixed(str_trim(line[1]), "\\s+", 6)[, 2]
    return(as.numeric(est))
  }
  return(NA_real_)
}

# Extract interaction p-value from anova output
get_interaction_p <- function(results_folder, var) {
  anova_file <- file.path(results_folder, paste0(var, "anova_long.txt"))
  if (!file.exists(anova_file)) return(NA_character_)
  cat("Looking for:", anova_file, "â†’ Exists:", file.exists(anova_file), "\n")
  lines <- readLines(anova_file)
  interaction_line <- grep("subtype:time_yr", lines, value = TRUE)
  
  if (length(interaction_line) == 1) {
    p_val <- str_extract(interaction_line, "\\d\\.\\d+(?=\\s*\\*|\\s*$)")
    return(if (!is.na(p_val)) round(as.numeric(p_val), 4) else NA)
  }
  return(NA_character_)
}

# -------- Main Loop --------

for (var in var_list) {
  results_folder <- paste0("Results_", var)
  model_file <- file.path(results_folder, paste0(var, "_longitudinal_model.txt"))
  slope_file <- file.path(results_folder, paste0(var, "_slope_compare_longitudinal.txt"))

  total_obs <- NA
  s1 <- s2 <- s3 <- NA
  inter_p <- NA
  s1_vs_s2 <- s1_vs_s3 <- s2_vs_s3 <- NA

  if (file.exists(model_file)) {
    lines <- readLines(model_file)

    # Extract total number of observations
    obs_line <- grep("Number of obs", lines, value = TRUE)
    if (length(obs_line)) {
      total_obs <- as.numeric(str_extract(obs_line, "\\d+"))
    }

    # Extract slopes from Fixed Effects section
    fixed_section_idx <- grep("Fixed effects:", lines)
    if (length(fixed_section_idx)) {
      coef_lines <- lines[(fixed_section_idx + 1):min(length(lines), fixed_section_idx + 20)]
      s1 <- get_estimate("time_yr", coef_lines)
      s2_inter <- get_estimate("subtype2:time_yr", coef_lines)
      s3_inter <- get_estimate("subtype3:time_yr", coef_lines)
      s2 <- if (!is.na(s1) && !is.na(s2_inter)) s1 + s2_inter else NA
      s3 <- if (!is.na(s1) && !is.na(s3_inter)) s1 + s3_inter else NA
    }
  }

  # Extract interaction p from anova file
  inter_p <- get_interaction_p(results_folder, var)

  # Extract pairwise p-values
  if (file.exists(slope_file)) {
    slope_lines <- readLines(slope_file)
    contrast_lines <- grep("^ subtype\\d+ - subtype\\d+", slope_lines, value = TRUE)
    if (length(contrast_lines) >= 3) {
      extract_p <- function(line) {
        val <- str_extract(line, "\\d+\\.\\d+$")
        return(as.numeric(val))
      }
      s1_vs_s2 <- extract_p(contrast_lines[1])
      s1_vs_s3 <- extract_p(contrast_lines[2])
      s2_vs_s3 <- extract_p(contrast_lines[3])
    }
  }

  # Add results to table
  summary_table <- rbind(summary_table, data.frame(
    Domain = NA,
    Variable = var,
    Subject_count = subject_counts[[var]],
    Total_Observations = total_obs,
    S1_Slope = round(s1, 3),
    S2_Slope = round(s2, 3),
    S3_Slope = round(s3, 3),
    Interaction_P = inter_p,
    S1_vs_S2 = s1_vs_s2,
    S1_vs_S3 = s1_vs_s3,
    S2_vs_S3 = s2_vs_s3,
    stringsAsFactors = FALSE
  ))
}



```
```{r}
# Read the reference file
var_range <- read.csv("cognitive measures.csv", stringsAsFactors = FALSE)

# Remove Domain from summary_table if it already exists
summary_table <- summary_table %>% dplyr::select(-Domain) 
#Merge and rename
summary_table <- summary_table %>%
  left_join(var_range %>% dplyr::select(domain,related_var, test_name),
            by = c("Variable" = "related_var")) %>%
  rename(
   Domain = domain,
    Test = test_name
  ) %>%
  relocate(Test, .after = Variable)  # Optional: move next to Variable
 
# Save the final table
write.csv(summary_table, "longitudinal_updated_long.csv", row.names = FALSE)
``` 